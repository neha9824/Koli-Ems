{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}
  {{ page_title }}
{% endblock page_title %}

{% block content %}
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">{{ page_title }}</h3>
          </div>
          
          <div class="card-body">
            <!-- Step 1: Department Selection -->
            <div class="form-group">
              <label>Department</label>
              <select class="form-control" id="department">
                <option value="">Select Department</option>
                {% for department in departments %}
                  <option value="{{ department.id }}">{{ department.name }}</option>
                {% endfor %}
              </select>
            </div>
            
            <!-- Step 2: Employee Selection -->
            <div class="form-group" id="employee_group" style="display: none;">
              <label>Employee</label>
              <select class="form-control" id="employee">
                <option value="">Select Employee</option>
              </select>
            </div>
            
            <!-- Step 3: Date Selection -->
            <div class="form-group" id="date_group" style="display: none;">
              <label>Date</label>
              <select class="form-control" id="attendance_date">
                <option value="">Select Date</option>
              </select>
            </div>
            
            <!-- Attendance Details -->
            <div id="attendance_details" style="display: none;">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-group">
                    <label>First Clock In</label>
                    <input type="time" class="form-control" id="first_clock_in">
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <label>Last Clock Out</label>
                    <input type="time" class="form-control" id="last_clock_out">
                  </div>
                </div>
              </div>
              
              <div class="form-group">
                <label>Status</label>
                <select class="form-control" id="status">
                  <option value="1">Present</option>
                  <option value="0">Absent</option>
                  <option value="2">Late</option>
                  <option value="3">Half Day</option>
                </select>
              </div>
              
              <button id="update_btn" class="btn btn-primary">Update Attendance</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
  // Department selection
  $('#department').change(function() {
    var department_id = $(this).val();
    if (!department_id) {
      $('#employee_group').hide();
      $('#date_group').hide();
      $('#attendance_details').hide();
      return;
    }
    
    $.ajax({
      url: "{% url 'get_employees' %}",
      type: "POST",
      data: {
        department_id: department_id,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        var options = '<option value="">Select Employee</option>';
        $.each(response, function(index, employee) {
          options += '<option value="' + employee.id + '">' + employee.name + '</option>';
        });
        $('#employee').html(options);
        $('#employee_group').show();
        $('#date_group').hide();
        $('#attendance_details').hide();
      },
      error: function(xhr) {
        alert('Error fetching employees: ' + xhr.responseText);
      }
    });
  });
  
  // Employee selection
  $('#employee').change(function() {
    var employee_id = $(this).val();
    if (!employee_id) {
      $('#date_group').hide();
      $('#attendance_details').hide();
      return;
    }
    
    $.ajax({
      url: "{% url 'get_attendance_dates' %}",
      type: "POST",
      data: {
        employee_id: employee_id,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        var options = '<option value="">Select Date</option>';
        $.each(response, function(index, date) {
          options += '<option value="' + date.date + '">' + date.display + '</option>';
        });
        $('#attendance_date').html(options);
        $('#date_group').show();
        $('#attendance_details').hide();
      },
      error: function(xhr) {
        alert('Error fetching dates: ' + xhr.responseText);
      }
    });
  });
  
  // Date selection
  $('#attendance_date').change(function() {
    var employee_id = $('#employee').val();
    var date = $(this).val();
    if (!employee_id || !date) {
      $('#attendance_details').hide();
      return;
    }
    
    $.ajax({
      url: "{% url 'get_attendance_details' %}",
      type: "POST",
      data: {
        employee_id: employee_id,
        date: date,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        $('#first_clock_in').val(response.first_clock_in || '');
        $('#last_clock_out').val(response.last_clock_out || '');
        $('#status').val(response.status);
        $('#attendance_details').show();
      },
      error: function(xhr) {
        alert('Error fetching attendance details: ' + xhr.responseText);
      }
    });
  });
  
  // Update attendance
  $('#update_btn').click(function() {
    var employee_id = $('#employee').val();
    var date = $('#attendance_date').val();
    var first_clock_in = $('#first_clock_in').val();
    var last_clock_out = $('#last_clock_out').val();
    var status = $('#status').val();
    
    if (!employee_id || !date) {
      alert('Please select employee and date');
      return;
    }
    
    $(this).prop('disabled', true).text('Updating...');
    
    $.ajax({
      url: "{% url 'update_attendance' %}",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        employee_id: employee_id,
        date: date,
        first_clock_in: first_clock_in,
        last_clock_out: last_clock_out,
        status: status,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      }),
      success: function(response) {
        alert(response.message);
        $('#update_btn').prop('disabled', false).text('Update Attendance');
      },
      error: function(xhr) {
        alert('Error updating attendance: ' + xhr.responseText);
        $('#update_btn').prop('disabled', false).text('Update Attendance');
      }
    });
  });
});
</script>
{% endblock custom_js %}