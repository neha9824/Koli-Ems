{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block custom_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<style>
    .filter-card {
        background-color: #f8fafc;
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .results-card {
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .select2-container--default .select2-selection--single {
        height: 44px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
    }
    
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 42px;
    }
    
    .btn-primary {
        background-color: #4f46e5;
        border-color: #4f46e5;
        height: 44px;
    }
    
    .status-badge {
        padding: 5px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .present {
        background-color: #dcfce7;
        color: #166534;
    }
    
    .absent {
        background-color: #fee2e2;
        color: #991b1b;
    }
    
    .late {
        background-color: #fef9c3;
        color: #854d0e;
    }
    
    .halfday {
        background-color: #e0f2fe;
        color: #075985;
    }
    
    .attendance-table {
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .attendance-table thead th {
        background-color: #f8fafc;
        border: none;
        padding: 12px 16px;
        font-weight: 600;
        color: #64748b;
    }
    
    .attendance-table tbody td {
        padding: 12px 16px;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .attendance-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .summary-card {
        background-color: #f8fafc;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 20px;
    }
    
    .summary-item {
        display: flex;
        align-items: center;
        margin-right: 20px;
    }
    
    .summary-count {
        font-weight: 600;
        margin-left: 8px;
    }
    
    .date-range {
        color: #64748b;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card filter-card mb-4">
                    <div class="card-body">
                        <h4 class="mb-4">View Attendance</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Department</label>
                                <select class="form-control select2" id="department">
                                    <option value="">All Departments</option>
                                    {% for department in departments %}
                                    <option value="{{ department.id }}">{{ department.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Employee</label>
                                <select class="form-control select2" id="employee">
                                    <option value="">All Employees</option>
                                    {% for employee in employees %}
                                    <option value="{{ employee.employee_id }}" data-department="{{ employee.department.id }}">{{ employee.admin.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Time Period</label>
                                <select class="form-control" id="time_period">
                                    <option value="week">This Week</option>
                                    <option value="month" selected>This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3 custom-date" style="display:none;">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="from_date">
                            </div>
                            <div class="col-md-4 mb-3 custom-date" style="display:none;">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="to_date">
                            </div>
                            <div class="col-md-4 mb-3 d-flex align-items-end">
                                <button id="view_attendance" class="btn btn-primary w-100">
                                    <i class="fas fa-filter mr-2"></i>Filter Results
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card results-card" id="attendance_results" style="display:none;">
                    <div class="card-body">
                        <h4 class="mb-4">Attendance Records</h4>
                        
                        <div class="d-flex flex-wrap mb-4" id="attendance_summary"></div>
                        
                        <div class="table-responsive">
                            <table class="table attendance-table" id="attendance_table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Day</th>
                                        <th>Status</th>
                                        <th>Clock In</th>
                                        <th>Clock Out</th>
                                        <th>Hours</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance_data">
                                    <!-- Filled by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-3 date-range" id="date_range"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block custom_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script>
$(document).ready(function() {
    // Initialize Select2
    $('.select2').select2({
        width: '100%',
        placeholder: $(this).find('option[value=""]').text()
    });

    // Department change handler to filter employees
    $('#department').change(function() {
        const departmentId = $(this).val();
        const $employeeSelect = $('#employee');
        
        // Show all options first
        $employeeSelect.find('option').show();
        
        if (departmentId) {
            // Hide employees not in the selected department, except the "All Employees" option
            $employeeSelect.find('option[value!=""]').each(function() {
                const employeeDept = $(this).data('department');
                if (employeeDept != departmentId) {
                    $(this).hide();
                }
            });
        }
        
        // Reset selection and update Select2
        $employeeSelect.val('').trigger('change');
        $employeeSelect.select2();
    });

    // Toggle custom date range fields
    $('#time_period').change(function() {
        if ($(this).val() === 'custom') {
            $('.custom-date').show();
        } else {
            $('.custom-date').hide();
        }
    });

    // View Attendance button click handler
    $('#view_attendance').click(function() {
        const employeeId = $('#employee').val();
        const departmentId = $('#department').val();
        const timePeriod = $('#time_period').val();
        
        let year = moment().format('YYYY');
        let month = null;
        let week = null;
        let fromDate = null;
        let toDate = null;

        if (timePeriod === 'custom') {
            fromDate = $('#from_date').val();
            toDate = $('#to_date').val();
            
            if (!fromDate || !toDate) {
                alert('Please select both From and To dates');
                return;
            }
            
            year = moment(fromDate).format('YYYY');
        } else {
            if (timePeriod === 'week') {
                fromDate = moment().startOf('week').add(1, 'days').format('YYYY-MM-DD');
                toDate = moment().endOf('week').add(1, 'days').format('YYYY-MM-DD');
            }
            else if (timePeriod === 'month') {
                month = moment().format('MM');
            }
        }

        fetchAttendanceData(employeeId, departmentId, year, month, week, fromDate, toDate);
    });

    // Fetch attendance data via AJAX
    function fetchAttendanceData(employeeId, departmentId, year, month, week, fromDate, toDate) {
        const data = {
            employee_id: employeeId,
            department_id: departmentId,
            year: year,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        };

        if (month) data.month = month;
        if (week) data.week = week;
        if (fromDate && toDate) {
            data.from_date = fromDate;
            data.to_date = toDate;
        }

        $.ajax({
            url: "{% url 'get_employee_attendance' %}",
            type: "POST",
            data: data,
            beforeSend: function() {
                $('#attendance_results').hide();
                $('#attendance_data').html('<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading attendance data...</p></td></tr>');
            },
            success: function(response) {
                if (response.error) {
                    $('#attendance_data').html(`<tr><td colspan="6" class="text-center py-4 text-danger">${response.error}</td></tr>`);
                    $('#attendance_results').show();
                } else if (response.length > 0) {
                    renderAttendanceTable(response);
                    $('#attendance_results').show();
                } else {
                    $('#attendance_data').html('<tr><td colspan="6" class="text-center py-4">No attendance records found for the selected criteria.</td></tr>');
                    $('#attendance_results').show();
                }
            },
            error: function(xhr, status, error) {
                $('#attendance_data').html('<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load attendance data. Please try again.</td></tr>');
                $('#attendance_results').show();
                console.error("Error:", error);
            }
        });
    }

    // Render attendance table
    function renderAttendanceTable(data) {
        let tableHtml = '';
        let presentCount = 0;
        let absentCount = 0;
        let lateCount = 0;
        let halfDayCount = 0;

        data.forEach(r => {
            const date = new Date(r.date);
            const day = date.toLocaleDateString([], { weekday: 'short' });
            const inTime = r.clock_in ? formatTime(r.clock_in) : '-';
            const outTime = r.clock_out ? formatTime(r.clock_out) : '-';
            const hours = calculateHours(r.clock_in, r.clock_out);
            const statusClass = getStatusClass(r.status.toLowerCase());

            // Count status types
            if (r.status.toLowerCase().includes('present')) presentCount++;
            if (r.status.toLowerCase().includes('absent')) absentCount++;
            if (r.status.toLowerCase().includes('late')) lateCount++;
            if (r.status.toLowerCase().includes('half')) halfDayCount++;

            tableHtml += `
                <tr>
                    <td>${r.date}</td>
                    <td>${day}</td>
                    <td><span class="status-badge ${statusClass}">${r.status}</span></td>
                    <td>${inTime}</td>
                    <td>${outTime}</td>
                    <td>${hours}</td>
                </tr>
            `;
        });

        $('#attendance_data').html(tableHtml);
        
        // Update summary
        const summaryHtml = `
            <div class="summary-item">
                <span class="status-badge present">Present</span>
                <span class="summary-count">${presentCount}</span>
            </div>
            <div class="summary-item">
                <span class="status-badge absent">Absent</span>
                <span class="summary-count">${absentCount}</span>
            </div>
            <div class="summary-item">
                <span class="status-badge late">Late</span>
                <span class="summary-count">${lateCount}</span>
            </div>
            <div class="summary-item">
                <span class="status-badge halfday">Half Day</span>
                <span class="summary-count">${halfDayCount}</span>
            </div>
        `;
        $('#attendance_summary').html(summaryHtml);
        
        // Update date range display
        const timePeriod = $('#time_period').val();
        let dateRangeText = '';
        
        if (timePeriod === 'custom') {
            dateRangeText = `Showing records from ${$('#from_date').val()} to ${$('#to_date').val()}`;
        } else {
            const today = new Date();
            
            if (timePeriod === 'week') {
                const start = moment().startOf('week').add(1, 'days').format('MMM D');
                const end = moment().endOf('week').add(1, 'days').format('MMM D, YYYY');
                dateRangeText = `Showing this week (${start} - ${end})`;
            } 
            else if (timePeriod === 'month') {
                dateRangeText = `Showing ${today.toLocaleDateString('default', { month: 'long', year: 'numeric' })}`;
            }
            else if (timePeriod === 'year') {
                dateRangeText = `Showing ${today.getFullYear()}`;
            }
        }
        
        $('#date_range').text(dateRangeText);
    }

    // Format time (HH:mm)
    function formatTime(dateTime) {
        return moment(dateTime).format('HH:mm');
    }

    // Calculate working hours
    function calculateHours(clockIn, clockOut) {
        if (!clockIn || !clockOut) return '-';
        const diff = moment(clockOut).diff(moment(clockIn), 'hours', true);
        return diff.toFixed(1) + 'h';
    }

    // Get status badge class
    function getStatusClass(status) {
        if (status.includes('present')) return 'present';
        if (status.includes('absent')) return 'absent';
        if (status.includes('late')) return 'late';
        if (status.includes('half')) return 'halfday';
        return '';
    }
});
</script>
{% endblock %}