{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}
  {{ page_title }}
{% endblock page_title %}

{% block content %}
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">

        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">{{ page_title }}</h3>
          </div>

          <div class="card-body">
            <div class="form-group">
              <label>Department</label>
              <select name="department" class="form-control" id="department">
                <option value="">----</option>
                {% for department in departments %}
                  <option value="{{ department.id }}">{{ department.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="form-group">
              <div id="error_attendance" class="alert alert-danger" style="display: none;"></div>
              <div id="success_attendance" class="alert alert-success" style="display: none;"></div>
              <button type="button" id="fetch_attendance" class="btn btn-primary btn-block">
                Fetch Attendance
              </button>
            </div>

            <div id="attendance_block" class="form-group" style="display: none;">
              <div class="form-group">
                <label>Attendance Date</label>
                <select name="attendance_date" id="attendance_date" class="form-control"></select>
              </div>

              <div id="fetch_employee_block" class="form-group" style="display: none;">
                <button type="button" id="fetch_employee" class="btn btn-primary btn-block">
                  Fetch Employees
                </button>
              </div>

              <div id="employee_data" class="card-footer"></div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {

  // Fetch Attendance Dates
  $("#fetch_attendance").click(function() {
    var department = $("#department").val();
    if (!department) {
      $("#error_attendance").html("Kindly choose a department").show();
      $("#attendance_block").hide();
      return;
    }

    $.ajax({
      url: "{% url 'get_attendance' %}",
      type: "POST",
      data: {
        department: department,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      dataType: "json", 
      success: function(response) {
        if (response.length > 0) {
          var html = "";
          for (var key in response) {
            html += "<option value='" + response[key]['id'] + "'>" + response[key]['attendance_date'] + "</option>";
          }
          $("#attendance_date").html(html);
          $("#error_attendance").hide();
          $("#attendance_block").show();
          $("#fetch_employee_block").show();
        } else {
          $("#error_attendance").html("No attendance dates found for the selected department").show();
          $("#attendance_block").hide();
        }
      },
      error: function(xhr, status, error) {
        alert("Error while fetching attendance dates: " + xhr.responseText);
      }
    });
  });

  // Fetch Employee List
  $("#fetch_employee").click(function() {
    var attendance_date = $("#attendance_date").val();
    $("#employee_data").html('');  // Clear previous data

    if (!attendance_date) {
      alert("Please choose an attendance date.");
      return;
    }

    $.ajax({
      url: "{% url 'get_employee_attendance' %}",
      type: "POST",
      data: {
        attendance_date_id: attendance_date,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      dataType: "json", 
      success: function(response) {
        if (response.length > 0) {
          var div_data = `
            <hr/>
            <div class="form-group">
              <label>Employee Attendance</label>
              <div class="row">
          `;

          for (var key in response) {
            div_data += `
              <div class="col-lg-3">
                <div class="form-check custom-control custom-checkbox">
                  <input type="checkbox" class="custom-control-input" 
                    ${response[key]['status'] ? "checked" : ""} 
                    name="employee_data[]" value="${response[key]['id']}" id="checkbox${response[key]['id']}" />
                  <label class="custom-control-label" for="checkbox${response[key]['id']}">
                    ${response[key]['name']} ${response[key]['status'] ? "[Present]" : "[Absent]"}
                  </label>
                </div>
              </div>
            `;
          }

          div_data += `
              </div>
            </div>
            <div class="form-group">
              <button id="save_attendance" class="btn btn-success" type="button">Save Attendance</button>
            </div>
          `;

          $("#employee_data").html(div_data);
        } else {
          alert("No employee data to display.");
        }
      },
      error: function(xhr, status, error) {
        alert("Error while fetching employees: " + xhr.responseText);
      }
    });
  });

  // Save Attendance
  $(document).on('click', '#save_attendance', function() {
    var employee_data = $("input[name='employee_data[]']").map(function() {
      return {
        id: $(this).val(),
        status: $(this).is(":checked") ? 1 : 0
      };
    }).get();

    var attendance_date = $("#attendance_date").val();
    if (!attendance_date) {
      alert("Please choose an attendance date.");
      return;
    }

    $(this).text("Saving...");

    $.ajax({
      url: "{% url 'update_attendance' %}",
      type: "POST",
      data: {
        date: attendance_date,
        employee_ids: JSON.stringify(employee_data),
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      dataType: "json", 
      success: function(response) {
        if (response.message) {
          alert(response.message);
          location.reload();  // Reload to reflect changes
        } else {
          alert("Error updating attendance. Please try again.");
        }
      },
      error: function(xhr, status, error) {
        alert("Error while saving attendance: " + xhr.responseText);
      }
    });
  });

});
</script>
{% endblock custom_js %}
