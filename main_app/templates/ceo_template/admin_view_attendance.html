{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block custom_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Department and Employee Selection -->
        <div class="card card-primary">
            <div class="card-header">
                <h3 class="card-title">{{ page_title }}</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Department</label>
                    <select name="department" class="form-control" id="department">
                        <option value="">----</option>
                        {% for department in departments %}
                        <option value="{{ department.id }}">{{ department.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Employee</label>
                    <select name="employee" class="form-control" id="employee">
                        <option value="">----</option>
                        {% for employee in employees %}
                        <option value="{{ employee.employee_id }}">{{ employee.admin.first_name }} {{ employee.admin.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- âœ… View Attendance Button moved inside the card-body -->
                <div class="form-group mt-3">
                    <button class="btn btn-primary btn-block" id="open_view_attendance">
                        <i class="fas fa-eye"></i> View Attendance for Selected Employee
                    </button>
                </div>
            </div>
        </div>

        <!-- Attendance Display Section -->
        <div class="card card-primary mt-4" id="attendance_section" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">View Attendance</h4>
                <div class="btn-group ml-auto">
                    <button type="button" id="this_week" class="btn btn-warning">This Week</button>
                    <button type="button" id="this_month" class="btn btn-info">This Month</button>
                    <button type="button" id="this_year" class="btn btn-success">This Year</button>
                    <button type="button" id="filter_btn" class="btn btn-primary">Filter</button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label>Select Month:</label>
                        <select id="month" class="form-control select2">
                            <option value="">-- Month --</option>
                            {% for m in months %}
                            <option value="{{ m.0 }}">{{ m.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label>Select Year:</label>
                        <select id="year" class="form-control select2">
                            <option value="">-- Year --</option>
                            {% for y in years %}
                            <option value="{{ y }}">{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <button type="button" id="view_attendance" class="btn btn-success btn-block">
                    <i class="fas fa-calendar-check"></i> View Attendance
                </button>
                <div id="attendance_details" class="mt-4"></div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block custom_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<script>
$(document).ready(function () {
    $("#department, #employee, #month, #year").select2({ width: '100%' });

    // Show attendance section
    $("#open_view_attendance").click(function () {
        const department = $("#department").val();
        const employeeId = $("#employee").val();
    
        if (!department || !employeeId) {
            alert("Please select both department and employee.");
            return;
        }
    
        $("#attendance_section").slideDown();
    });
    

    // View or Filter button clicked
    $("#view_attendance, #filter_btn").click(function () {
        // Allow manual month/year selection
        $("#month, #year").prop('disabled', false);
        const employeeId = $("#employee").val();
        const month = $("#month").val();
        const year = $("#year").val();

        if (!employeeId || (!month && !year)) {
            alert("Please select employee and at least month or year.");
            return;
        }

        fetchAttendanceData(employeeId, month, year, null);
    });

    // Quick filter: This Week, Month, Year
    $("#this_week, #this_month, #this_year").click(function () {
        const today = new Date();
        const employeeId = $("#employee").val();
        let month = null, year = today.getFullYear(), week = null;

        if (!employeeId) {
            alert("Please select an employee.");
            return;
        }

        if (this.id === "this_week") {
            week = getWeekNumber(today);
        } else if (this.id === "this_month") {
            month = today.getMonth() + 1;
        }

        // Disable and reset month/year
        $("#month, #year").val('').trigger('change').prop('disabled', true);

        fetchAttendanceData(employeeId, month, year, week);
    });

    // Automatically re-enable dropdowns when clicked
    $("#month, #year").on("select2:opening", function () {
        $(this).prop("disabled", false);
    });

    // Week number logic
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        let dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    // AJAX call
    function fetchAttendanceData(employeeId, month, year, week) {
        $.ajax({
            url: "{% url 'get_employee_attendance' %}",
            type: "POST",
            data: {
                employee_id: employeeId,
                month: month,
                year: year,
                week: week,
                csrfmiddlewaretoken: '{{ csrf_token }}',
            },
            success: function (response) {
                let html = "";
                if (response.length > 0) {
                    const emp = response[0];
                    html += `<div><strong>Employee:</strong> ${emp.employee_name} | <strong>Department:</strong> ${emp.department}</div>`;
                    html += `<table class="table table-bordered mt-2"><thead>
                                <tr><th>Date</th><th>Status</th><th>Clock In</th><th>Clock Out</th></tr>
                             </thead><tbody>`;
                    response.forEach(r => {
                        const inTime = r.clock_in ? formatTime(r.clock_in) : '-';
                        const outTime = r.clock_out ? formatTime(r.clock_out) : '-';
                        html += `<tr><td>${r.date}</td><td>${r.status}</td><td>${inTime}</td><td>${outTime}</td></tr>`;
                    });
                    html += "</tbody></table>";
                } else {
                    html = "<p>No attendance records found.</p>";
                }
                $("#attendance_details").html(html);
            }
        });
    }

    // Function to format clock-in/clock-out time
    function formatTime(dateTimeStr) {
        if (!dateTimeStr) return '-';
        const time = new Date(dateTimeStr);
        return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
});
</script>
{% endblock %}
