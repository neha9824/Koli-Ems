{% extends 'main_app/base.html' %}
{% load static %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{ page_title }}</h3>
                        <button class="btn btn-primary float-right" data-toggle="modal" data-target="#bulkNotificationModal">
                            Send Bulk Notification
                        </button>
                        <button class="btn btn-info float-right mr-2" data-toggle="modal" data-target="#selectiveNotificationModal">
                            Send to Selected
                        </button>
                    </div>
                    <div class="card-body" id="manager-table-container">
                        <table id="example2" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>SN</th>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Gender</th>
                                    <th>Division</th>
                                    <th>Avatar</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for manager in allManager %}
                                <tr>
                                    <td><input type="checkbox" class="managerCheckbox" value="{{ manager.id }}"></td>
                                    <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                                    <td>{{ manager.last_name }} {{ manager.first_name }}</td>
                                    <td>{{ manager.email }}</td>
                                    <td>{{ manager.gender }}</td>
                                    <td>{{ manager.manager.division.name }}</td>
                                    <td>
                                        {% if manager.profile_pic %}
                                            <img class="img img-fluid mb-2" height="100" width="100" src="{{ manager.profile_pic.url }}" alt="Avatar">
                                        {% else %}
                                            No Image
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button data-toggle="modal" 
                                                data-target="#myModal" 
                                                class="btn btn-primary show_notification" 
                                                value="{{ manager.id }}">Send Notification</button>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center">No managers found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-center mt-3">
                            <nav>
                                <ul class="pagination">
                                    <!-- Previous page (<) -->
                                    <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
                                        <a class="page-link pagination-link" 
                                           href="?page={% if page_obj.has_previous %}{{ page_obj.previous_page_number }}{% else %}#{% endif %}" 
                                           data-page="{% if page_obj.has_previous %}{{ page_obj.previous_page_number }}{% endif %}" 
                                           aria-label="Previous">
                                            <span aria-hidden="true">«</span>
                                        </a>
                                    </li>
                                    
                                    <!-- Page numbers -->
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link">{{ num }}</span>
                                            </li>
                                        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                            <li class="page-item">
                                                <a class="page-link pagination-link" 
                                                   href="?page={{ num }}" 
                                                   data-page="{{ num }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Next page (>) -->
                                    <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
                                        <a class="page-link pagination-link" 
                                           href="?page={% if page_obj.has_next %}{{ page_obj.next_page_number }}{% else %}#{% endif %}" 
                                           data-page="{% if page_obj.has_next %}{{ page_obj.next_page_number }}{% endif %}" 
                                           aria-label="Next">
                                            <span aria-hidden="true">»</span>
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Individual Notification Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="individualNotificationLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="individualNotificationLabel">Send Notification</h5>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <input type="text" id="message" class="form-control" placeholder="Enter message">
                    <input type="hidden" id="manager_id" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="send" class="btn btn-success send_notification">Send Notification</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Notification Modal -->
<div class="modal fade" id="bulkNotificationModal" tabindex="-1" role="dialog" aria-labelledby="bulkNotificationLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkNotificationLabel">Send Bulk Notification</h5>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="bulkMessage" class="form-control" placeholder="Enter message"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="sendBulk" class="btn btn-success send_bulk_notification">Send to All Managers</button>
            </div>
        </div>
    </div>
</div>

<!-- Selective Notification Modal -->
<div class="modal fade" id="selectiveNotificationModal" tabindex="-1" role="dialog" aria-labelledby="selectiveNotificationLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="selectiveNotificationLabel">Send to Selected Managers</h5>
                <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <textarea id="selectiveMessage" class="form-control" placeholder="Enter message for selected managers"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                <button type="button" id="sendSelected" class="btn btn-success send_selected_notification">Send to Selected</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    // Handle pagination clicks
    $(document).on('click', '.pagination-link', function(e) {
        e.preventDefault();
        var page = $(this).data('page');
        if (!page) return; // Skip if no page data (disabled link)

        $.ajax({
            url: "{% url 'admin_notify_manager' %}",
            type: 'GET',
            data: {
                page: page
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(html) {
                // Create a temporary container to parse the full HTML
                var $temp = $('<div>').html(html);
                // Extract only the #manager-table-container content
                var $newContent = $temp.find('#manager-table-container').html();
                // Update the existing container
                $('#manager-table-container').html($newContent);
                // Update browser URL without reloading
                window.history.pushState({}, '', '?page=' + page);
            },
            error: function(xhr, status, error) {
                console.error('Pagination AJAX failed:', error);
                alert('Error loading page. Please try again.');
            }
        });
    });

    // Handle browser back/forward buttons
    window.onpopstate = function(event) {
        window.location.reload(); // Reload to ensure correct state
    };

    // Handle select all checkbox
    $(document).on('click', '#selectAll', function() {
        $('.managerCheckbox').prop('checked', $(this).prop('checked'));
    });

    // Handle show notification modal
    $(document).on('click', '.show_notification', function() {
        $('#manager_id').val($(this).val());
    });

    // Handle send individual notification
    $(document).on('click', '.send_notification', function() {
        var id = $('#manager_id').val();
        var message = $('#message').val();
        if (message.trim() == '') {
            alert('Please enter a message');
            return;
        }
        sendNotification(id, message);
    });

    // Handle send bulk notification
    $(document).on('click', '.send_bulk_notification', function() {
        var message = $('#bulkMessage').val();
        if (message.trim() === '') {
            alert('Please enter a message');
            return;
        }
        sendBulkNotification(message);
    });

    // Handle send selected notification
    $(document).on('click', '.send_selected_notification', function() {
        var message = $('#selectiveMessage').val();
        if (message.trim() === '') {
            alert('Please enter a message');
            return;
        }
        var selectedManagers = [];
        $('.managerCheckbox:checked').each(function() {
            selectedManagers.push($(this).val());
        });

        if (selectedManagers.length === 0) {
            alert('Please select at least one manager');
            return;
        }

        sendSelectedNotification(selectedManagers, message);
    });

    function sendNotification(id, message) {
        $.ajax({
            url: "{% url 'send_manager_notification' %}",
            type: 'POST',
            data: {
                id: id,
                message: message,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response === 'True') {
                    alert('Notification Sent');
                    $('#myModal').modal('hide');
                    $('#message').val('');
                    location.reload();
                } else {
                    alert('Notification could not be sent. Please try again.');
                }
            },
            error: function() {
                alert('Error in sending notification');
            }
        });
    }

    function sendBulkNotification(message) {
        $.ajax({
            url: "{% url 'send_bulk_manager_notification' %}",
            type: 'POST',
            data: {
                message: message,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response === 'True') {
                    alert('Bulk Notification Sent');
                    $('#bulkNotificationModal').modal('hide');
                    $('#bulkMessage').val('');
                } else {
                    alert('Bulk Notification could not be sent. Please try again.');
                }
            },
            error: function() {
                alert('Error in sending bulk notification');
            }
        });
    }

    function sendSelectedNotification(selectedManagers, message) {
        $.ajax({
            url: "{% url 'send_selected_manager_notification' %}",
            type: 'POST',
            data: {
                manager_ids: JSON.stringify(selectedManagers),
                message: message,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response === 'True') {
                    alert('Notification Sent to Selected Managers');
                    $('#selectiveNotificationModal').modal('hide');
                    $('#selectiveMessage').val('');
                    $('.managerCheckbox').prop('checked', false);
                    $('#selectAll').prop('checked', false);
                } else {
                    alert('Notification could not be sent. Please try again.');
                }
            },
            error: function() {
                alert('Error in sending notification');
            }
        });
    }
});
</script>
{% endblock custom_js %}