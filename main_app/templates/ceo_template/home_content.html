{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}

{% block custom_css %}
<style>
  /* Gradient Backgrounds */
  .bg-gradient-primary {
      background: linear-gradient(135deg, #667eea 0%,rgb(64, 11, 117) 100%) !important;
  }
  .bg-gradient-success {
      background: linear-gradient(135deg,rgb(14, 121, 73) 0%,rgb(12, 107, 166) 100%) !important;
  }
  .bg-gradient-info {
      background: linear-gradient(135deg,rgb(60, 86, 130) 0%,rgb(30, 40, 11) 100%) !important;
  }
  .bg-gradient-warning {
      background: linear-gradient(135deg,rgb(104, 91, 49) 0%,rgb(163, 159, 16) 100%) !important;
  }
  .bg-pattern-1 {
      background: linear-gradient(135deg,rgb(29, 85, 134) 0%,rgb(230, 98, 28) 100%) !important;
  }
  .bg-pattern-2 {
      background: linear-gradient(135deg,rgb(187, 34, 204) 0%,rgb(24, 192, 49) 100%) !important;
  }
  .row{
    color: black !important;
  }
  
  /* Icon Circle */
  .icon-circle {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
  }
  
  .bg-white-20 {
      background-color: rgba(255,255,255,0.2);
  }
  
  /* Card Hover Effects */
  .card {
      transition: all 0.3s ease;
      border-radius: 10px;
      overflow: hidden;
  }
  
  .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
  }
  
  /* Badges */
  .badge {
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 20px;
  }
  
  /* Buttons */
  .btn {
      border-radius: 8px;
      padding: 10px 15px;
      font-weight: 500;
      transition: all 0.3s;
  }
  
  .btn:hover {
      transform: translateY(-2px);
  }
  
  /* Card Header */
  .card-header {
      border-radius: 10px 10px 0 0 !important;
  }

  /* Holiday Calendar Styles - Updated Professional Styles */
  #holiday-calendar {
      width: 100%;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      border: 1px solid #e0e0e0;
  }
  
  .fc-event {
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 0.85em;
      border: none;
      background-color: #dc3545;
  }
  
  .holiday-controls-container {
      background-color: #ffffff;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      height: 100%;
      padding: 20px;
  }
  
  .holiday-list-container {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 20px;
      border-top: 1px solid #f0f0f0;
      padding-top: 15px;
  }
  
  .holiday-list-item {
      transition: all 0.2s;
      padding: 10px 15px;
      margin-bottom: 8px;
      background-color: #f9f9f9;
      border-radius: 6px;
      border-left: 3px solid #dc3545;
  }
  
  .holiday-list-item:hover {
      background-color: #f1f1f1;
  }
  
  .holiday-date-badge {
      background-color: #e9f0ff;
      color: #3a7afe;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-right: 8px;
  }
  
  .holiday-form-label {
      font-weight: 500;
      color: #555;
      margin-bottom: 5px;
      display: block;
  }
  
  @media (max-width: 768px) {
      #holiday-calendar {
          height: 400px;
          margin-bottom: 20px;
      }
  }
</style>
{% endblock custom_css %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <!-- Key Metrics Row - Colorful Cards -->
        <div class="row">
            <!-- Employee Card -->
            <div class="col-md-3 mb-4">
                <div class="card bg-gradient-primary text-white h-100 shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1">Total Employees</h6>
                                <h2 class="mb-0">{{ total_employees }}</h2>
                            </div>
                            <div class="icon-circle bg-white-20">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'manage_employee' %}" class="text-white text-decoration-none small">
                                View all <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Manager Card -->
            <div class="col-md-3 mb-4">
                <div class="card bg-gradient-success text-white h-100 shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1">Total Managers</h6>
                                <h2 class="mb-0">{{ total_manager }}</h2>
                            </div>
                            <div class="icon-circle bg-white-20">
                                <i class="fas fa-user-tie"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'manage_manager' %}" class="text-white text-decoration-none small">
                                View all <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Division Card -->
            <div class="col-md-3 mb-4">
                <div class="card bg-gradient-info text-white h-100 shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1">Total Divisions</h6>
                                <h2 class="mb-0">{{ total_division }}</h2>
                            </div>
                            <div class="icon-circle bg-white-20">
                                <i class="fas fa-sitemap"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'manage_division' %}" class="text-white text-decoration-none small">
                                View all <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Department Card -->
            <div class="col-md-3 mb-4">
                <div class="card bg-gradient-warning text-white h-100 shadow">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="text-uppercase mb-1">Total Departments</h6>
                                <h2 class="mb-0">{{ total_department }}</h2>
                            </div>
                            <div class="icon-circle bg-white-20">
                                <i class="fas fa-building"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <a href="{% url 'manage_department' %}" class="text-white text-decoration-none small">
                                View all <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Asset Management Section -->
        <div class="row">
            <!-- Asset Summary -->
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0 text-dark">Asset Management</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Total Assets -->
                            <div class="col-md-6 mb-4">
                                <div class="card bg-pattern-1 text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                <i class="fas fa-boxes fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Total Assets</h6>
                                                <h3 class="mb-2">{{ total_assets }}</h3>
                                                <div class="d-flex">
                                                    <span class="badge bg-white text-primary mr-2">{{ active_assets }} Active</span>
                                                    <span class="badge bg-white text-secondary">{{ inactive_assets }} Inactive</span>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="{% url 'asset_app:assets-list' %}" class="stretched-link"></a>
                                    </div>
                                </div>
                            </div>
    
                            <!-- Maintenance -->
                            <div class="col-md-6 mb-4">
                                <div class="card bg-pattern-2 text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="mr-3">
                                                <i class="fas fa-tools fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="mb-1">Maintenance History</h6>
                                                <h3 class="mb-2">{{ total_resolved_issues }}</h3>
                                                <div class="d-flex align-items-center">
                                                    <span class="badge bg-white text-danger mr-2">{{ recurring_issues }} Recurring</span>
                                                </div>
                                            </div>
                                        </div>
                                        <a href="{% url 'admin_asset_issue_history' %}" class="stretched-link"></a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Quick Actions -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="mb-0 text-dark">Quick Actions</h5>
                    </div>
                    <div class="card-body">
                        <a href="{% url 'add_employee' %}" class="btn btn-primary btn-block text-left mb-3">
                            <i class="fas fa-user-plus mr-2"></i> Add New Employee
                        </a>
                        <a href="{% url 'asset_app:assets-list' %}" class="btn btn-success btn-block text-left mb-3">
                            <i class="fas fa-box-open mr-2"></i> View Assets
                        </a>
                        <a href="{% url 'generate_performance_report' %}" class="btn btn-info btn-block text-left mb-3">
                            <i class="fas fa-file-alt mr-2"></i> Generate Reports
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Holiday Management Section - Redesigned -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h3 class="card-title mb-0">
                            <i class="fas fa-calendar-alt text-primary mr-2"></i>
                            Holiday Calendar
                        </h3>
                        <div>
                            <button id="save-holidays" class="btn btn-primary btn-sm">
                                <i class="fas fa-save mr-1"></i> Save Changes
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Calendar Column -->
                            <div class="col-md-8">
                                <div id="holiday-calendar"></div>
                            </div>
                            
                            <!-- Controls Column -->
                            <div class="col-md-4">
                                <div class="holiday-controls-container">
                                    <h5 class="mb-4">Holiday Details</h5>
                                    
                                    <div class="mb-3">
                                        <label class="holiday-form-label">Selected Date</label>
                                        <input type="date" id="holiday-date" class="form-control form-control-sm" readonly>
                                    </div>
                                    
                                    <div class="mb-4">
                                        <label class="holiday-form-label">Holiday Name</label>
                                        <input type="text" id="holiday-name" class="form-control" placeholder="Enter holiday name">
                                    </div>
                                    
                                    <div class="d-flex gap-2 mb-4">
                                        <button id="add-holiday" class="btn btn-success flex-grow-1">
                                            <i class="fas fa-plus mr-1"></i> Add
                                        </button>
                                        <button id="remove-holiday" class="btn btn-outline-danger">
                                            <i class="fas fa-trash-alt mr-1"></i> Remove
                                        </button>
                                    </div>
                                    
                                    <div class="holiday-list-container">
                                        <h5 class="mb-3">Scheduled Holidays</h5>
                                        <div id="holiday-list">
                                            {% for holiday in holidays %}
                                            <div class="holiday-list-item d-flex justify-content-between align-items-center" 
                                                 data-id="{{ holiday.id }}" data-date="{{ holiday.date|date:'Y-m-d' }}">
                                                <div>
                                                    <span class="holiday-date-badge">
                                                        {{ holiday.date|date:"M d" }}
                                                    </span>
                                                    <span>{{ holiday.name }}</span>
                                                </div>
                                                <button class="btn btn-xs btn-icon btn-outline-danger delete-holiday">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                            {% empty %}
                                            <div class="text-center text-muted py-3">
                                                <i class="fas fa-calendar-times fa-lg mb-2"></i>
                                                <p>No holidays scheduled</p>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function(){
    // Initialize holiday calendar
    var calendar = $('#holiday-calendar').fullCalendar({
        header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,agendaWeek,agendaDay'
        },
        defaultView: 'month',
        editable: true,
        selectable: true,
        selectHelper: true,
        height: 650,
        events: [
            {% for holiday in holidays %}
            {
                title: '{{ holiday.name }}',
                start: '{{ holiday.date|date:"Y-m-d" }}',
                color: '#dc3545',
                id: '{{ holiday.id }}'
            },
            {% endfor %}
        ],
        dayClick: function(date, jsEvent, view) {
            $('#holiday-date').val(date.format('YYYY-MM-DD'));
            $('#holiday-name').focus();
        },
        eventClick: function(calEvent, jsEvent, view) {
            $('#holiday-date').val(calEvent.start.format('YYYY-MM-DD'));
            $('#holiday-name').val(calEvent.title);
        }
    });

    // Add holiday button
    $('#add-holiday').click(function() {
        var date = $('#holiday-date').val();
        var name = $('#holiday-name').val().trim();
        
        if (!date) {
            toastr.warning('Please select a date first by clicking on the calendar');
            return;
        }
        
        if (!name) {
            toastr.warning('Please enter a holiday name');
            return;
        }
        
        // Add to calendar
        calendar.fullCalendar('renderEvent', {
            title: name,
            start: date,
            color: '#dc3545',
            temporary: true
        }, true);
        
        // Add to list
        addHolidayToList(date, name);
        
        // Clear form
        $('#holiday-name').val('');
        toastr.success('Holiday added (remember to save changes)');
    });

    // Remove holiday button
    $('#remove-holiday').click(function() {
        var date = $('#holiday-date').val();
        if (!date) {
            toastr.warning('Please select a date first');
            return;
        }
        
        // Remove from calendar
        calendar.fullCalendar('removeEvents', function(event) {
            return event.start.format('YYYY-MM-DD') === date;
        });
        
        // Remove from list
        $(`#holiday-list div[data-date="${date}"]`).remove();
        
        // Clear form
        $('#holiday-date').val('');
        $('#holiday-name').val('');
        
        // If no holidays left, show empty message
        if ($('#holiday-list .holiday-list-item').length === 0) {
            $('#holiday-list').html('<div class="text-center text-muted py-3"><i class="fas fa-calendar-times fa-lg mb-2"></i><p>No holidays scheduled</p></div>');
        }
        
        toastr.info('Holiday removed (remember to save changes)');
    });

    // Delete holiday from list
    $(document).on('click', '.delete-holiday', function() {
        var item = $(this).closest('.holiday-list-item');
        var id = item.data('id');
        var date = item.data('date');
        
        if (confirm('Are you sure you want to delete this holiday?')) {
            if (id) {
                // Delete from database
                $.ajax({
                    url: '{% url "delete_holiday" %}',
                    type: 'POST',
                    data: {
                        id: id,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function() {
                        toastr.success('Holiday deleted successfully');
                    }
                });
            }
            
            // Remove from calendar
            calendar.fullCalendar('removeEvents', function(event) {
                return event.id == id || event.start.format('YYYY-MM-DD') === date;
            });
            
            // Remove from list
            item.remove();
            
            // If no holidays left, show empty message
            if ($('#holiday-list .holiday-list-item').length === 0) {
                $('#holiday-list').html('<div class="text-center text-muted py-3"><i class="fas fa-calendar-times fa-lg mb-2"></i><p>No holidays scheduled</p></div>');
            }
        }
    });

    // Modified save holidays function
$('#save-holidays').click(function() {
    var events = calendar.fullCalendar('clientEvents');
    var holidays = [];
    
    // Validate no duplicate dates
    var dateMap = {};
    var hasDuplicates = false;
    
    $.each(events, function(index, event) {
        var dateStr = event.start.format('YYYY-MM-DD');
        if (dateMap[dateStr]) {
            toastr.error(`Duplicate holiday found for ${dateStr}. Please remove one.`);
            hasDuplicates = true;
            return false; // break loop
        }
        dateMap[dateStr] = true;
        
        holidays.push({
            date: dateStr,
            name: event.title,
            id: event.id || null
        });
    });
    
    if (hasDuplicates) return;
    
    // Show loading state
    var $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Saving...');
    
    // Send data to server
    $.ajax({
        url: '{% url "save_holidays" %}',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            holidays: holidays,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }),
        success: function(response) {
            if (response.success) {
                toastr.success('Holidays saved successfully!');
                
                // Remove all events and re-add them with proper IDs
                calendar.fullCalendar('removeEvents');
                
                $.each(response.holidays, function(index, holiday) {
                    calendar.fullCalendar('renderEvent', {
                        id: holiday.id,
                        title: holiday.name,
                        start: holiday.date,
                        color: '#dc3545'
                    }, true);
                });
                
                // Refresh holiday list
                refreshHolidayList();
            } else {
                toastr.error('Error: ' + (response.error || 'Failed to save holidays'));
                if (response.details) {
                    response.details.forEach(function(error) {
                        toastr.error(error);
                    });
                }
            }
        },
        error: function(xhr) {
            try {
                var err = JSON.parse(xhr.responseText);
                toastr.error('Error: ' + (err.error || 'Failed to save holidays'));
            } catch(e) {
                toastr.error('Failed to save holidays. Please try again.');
            }
        },
        complete: function() {
            $btn.prop('disabled', false).html('<i class="fas fa-save mr-1"></i> Save Changes');
        }
    });
});

// New function to refresh holiday list from server
function refreshHolidayList() {
    $.ajax({
        url: '{% url "get_holidays" %}',  // You'll need to create this view
        type: 'GET',
        success: function(response) {
            if (response.success && response.holidays) {
                var $list = $('#holiday-list');
                $list.empty();
                
                if (response.holidays.length === 0) {
                    $list.html('<div class="text-center text-muted py-3"><i class="fas fa-calendar-times fa-lg mb-2"></i><p>No holidays scheduled</p></div>');
                    return;
                }
                
                $.each(response.holidays, function(index, holiday) {
                    var date = new Date(holiday.date);
                    var formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    $list.append(`
                        <div class="holiday-list-item d-flex justify-content-between align-items-center" 
                             data-id="${holiday.id}" data-date="${holiday.date}">
                            <div>
                                <span class="holiday-date-badge">${formattedDate}</span>
                                <span>${holiday.name}</span>
                            </div>
                            <button class="btn btn-xs btn-icon btn-outline-danger delete-holiday">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `);
                });
            }
        }
    });
}

// Add this to your document.ready function
$(document).ready(function() {
    // Load holidays when page loads
    refreshHolidayList();
    
    // ... rest of your existing code ...
});
    // Helper function to add holiday to list
    function addHolidayToList(date, name) {
        var dateObj = new Date(date);
        var formattedDate = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        // Remove empty message if it exists
        if ($('#holiday-list .text-muted').length > 0) {
            $('#holiday-list').empty();
        }
        
        // Add new holiday to list
        $('#holiday-list').append(`
            <div class="holiday-list-item d-flex justify-content-between align-items-center" data-date="${date}">
                <div>
                    <span class="holiday-date-badge">${formattedDate}</span>
                    <span>${name}</span>
                </div>
                <button class="btn btn-xs btn-icon btn-outline-danger delete-holiday">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `);
    }
});
</script>

<!-- Include required libraries -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
{% endblock custom_js %}