{% extends 'main_app/base.html' %}
{% load static %}

{% block custom_css %}
<style>
    .update-container { max-width: 800px; margin: 0 auto; }
    .update-item { display: grid; grid-template-columns: 1fr 120px 60px; gap: 10px; margin-bottom: 8px; align-items: center; }
    .update-input, .time-spent { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
    .update-btn { background-color: #f3f4f6; color: #6b7280; border: none; border-radius: 6px; padding: 8px; }
    .save-btn { background-color: #10b981; color: white; width: 100%; padding: 10px; margin-top: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="container py-8">
    <div class="update-container">
        <div class="section-card">
            <h3 class="section-title">Today's Schedule</h3>
            {% if schedule.tasks %}
                <ol>
                    {% for task in schedule.tasks %}
                    <li>{{ task.description }} <span class="time-estimate">({{ task.time }})</span></li>
                    {% endfor %}
                </ol>
            {% else %}
                <div class="text-center py-4">No schedule found</div>
            {% endif %}
        </div>

        <div class="section-card">
            <h3 class="section-title">Daily Update</h3>
            <div id="updates-container">
                {% if update.updates %}
                    {% for update_line in update.updates %}
                    <div class="update-item">
                        <input type="text" class="update-input" value="{{ update_line.description }}" 
                               {% if not is_editable %}readonly{% endif %} placeholder="Update">
                        <input type="text" class="time-spent" value="{{ update_line.time }}" 
                               {% if not is_editable %}readonly{% endif %} placeholder="Time spent">
                        {% if is_editable %}<button class="update-btn">Edit</button>{% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="update-item">
                        <input type="text" class="update-input" placeholder="Update">
                        <input type="text" class="time-spent" placeholder="Time spent">
                        <button class="update-btn">Edit</button>
                    </div>
                {% endif %}
            </div>
            
            {% if is_editable %}
                <button id="add-update-btn" class="task-btn add-btn mt-3">+ Add Update</button>
                <button id="save-update-btn" class="save-btn">Save Update</button>
            {% endif %}
        </div>
    </div>
</div>

<form id="update-form" method="post" action="{% url 'todays_update' %}">
    {% csrf_token %}
    <input type="hidden" name="update_description" id="update-description-input">
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('updates-container');
    const addBtn = document.getElementById('add-update-btn');
    const saveBtn = document.getElementById('save-update-btn');

    if (addBtn) {
        addBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = 'update-item';
            div.innerHTML = `
                <input type="text" class="update-input" placeholder="Update">
                <input type="text" class="time-spent" placeholder="Time spent">
                <button class="update-btn">Edit</button>
            `;
            container.appendChild(div);
        });
    }

    if (saveBtn) {
        saveBtn.addEventListener('click', () => {
            const updates = [];
            let isValid = true;

            document.querySelectorAll('.update-item').forEach(item => {
                const desc = item.querySelector('.update-input').value.trim();
                const time = item.querySelector('.time-spent').value.trim();
                
                if (!desc || !time) {
                    isValid = false;
                    alert('Please fill both update and time spent fields');
                    return;
                }
                
                updates.push(`${desc}|${time}`);
            });

            if (isValid && updates.length > 0) {
                document.getElementById('update-description-input').value = updates.join('\n');
                document.getElementById('update-form').submit();
            }
        });
    }
});
</script>
{% endblock %}