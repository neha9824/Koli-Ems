{% extends 'main_app/base.html' %}
{% load static %}

{% block custom_css %}
<style>
    .schedule-container { max-width: 800px; margin: 0 auto; }
    .section-card { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); padding: 20px; margin-bottom: 20px; }
    .task-item { display: grid; grid-template-columns: 1fr 120px 32px; gap: 10px; margin-bottom: 8px; align-items: center; }
    .task-input, .time-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; transition: all 0.3s; }
    .task-input:focus, .time-input:focus { border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }
    .task-btn { border: none; border-radius: 6px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; background-color: #e0e7ff; color: #3730a3; }
    .add-btn { background-color: #4f46e5; color: white; width: 100%; padding: 10px; margin-top: 10px; }
    .save-btn { background-color: #10b981; color: white; width: 100%; padding: 10px; margin-top: 15px; }
    .time-estimate { color: #6b7280; font-size: 0.9em; }
</style>
{% endblock %}

{% block content %}
<div class="container py-8">
    <div class="schedule-container">
        <div class="section-card">
            <h3 class="section-title">Daily Tasks</h3>
            <div class="mb-4">
                <input type="text" id="project-input" class="w-100 p-2 border rounded-md" 
                       value="{{ schedule.project|default:'' }}" placeholder="Project name">
            </div>
            <div class="task-input-container">
                <div id="tasks-container">
                    {% if schedule.tasks %}
                        {% for task in schedule.tasks %}
                        <div class="task-item">
                            <input type="text" class="task-input" value="{{ task.description }}" placeholder="Task">
                            <input type="text" class="time-input" value="{{ task.time }}" placeholder="Time">
                            <button type="button" class="task-btn">✎</button>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="task-item">
                            <input type="text" class="task-input" placeholder="Task">
                            <input type="text" class="time-input" placeholder="Time">
                            <button type="button" class="task-btn">✎</button>
                        </div>
                    {% endif %}
                </div>
                <button type="button" id="add-task-btn" class="task-btn add-btn">+ Add Task</button>
            </div>
            <button id="save-schedule-btn" class="save-btn">Save Schedule</button>
        </div>

        <div class="section-card">
            <h3 class="section-title">History</h3>
            {% if schedule %}
                <div class="schedule-display">
                    {% if schedule.project %}<div class="mb-2"><strong>Project:</strong> {{ schedule.project }}</div>{% endif %}
                    <ol>
                        {% for task in schedule.tasks %}
                        <li>{{ task.description }} <span class="time-estimate">({{ task.time }})</span></li>
                        {% endfor %}
                    </ol>
                </div>
            {% else %}
                <div class="text-center py-4">No schedule found</div>
            {% endif %}
        </div>
    </div>
</div>

<form id="schedule-form" method="post" action="{% url 'daily_schedule' %}">
    {% csrf_token %}
    <input type="hidden" name="task_description" id="task-description-input">
    <input type="hidden" name="project" id="form-project-input">
</form>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('tasks-container');
    const addBtn = document.getElementById('add-task-btn');
    const saveBtn = document.getElementById('save-schedule-btn');

    addBtn.addEventListener('click', () => {
        const div = document.createElement('div');
        div.className = 'task-item';
        div.innerHTML = `
            <input type="text" class="task-input" placeholder="Task">
            <input type="text" class="time-input" placeholder="Time">
            <button type="button" class="task-btn">✎</button>
        `;
        container.appendChild(div);
    });

    saveBtn.addEventListener('click', () => {
        const tasks = [];
        let isValid = true;

        document.querySelectorAll('.task-item').forEach(item => {
            const task = item.querySelector('.task-input').value.trim();
            const time = item.querySelector('.time-input').value.trim();
            
            if (!task || !time) {
                isValid = false;
                alert('Please fill both task and time fields');
                return;
            }
            
            tasks.push(`${task}|${time}`);
        });

        if (isValid && tasks.length > 0) {
            document.getElementById('task-description-input').value = tasks.join('\n');
            document.getElementById('form-project-input').value = 
                document.getElementById('project-input').value.trim();
            document.getElementById('schedule-form').submit();
        }
    });
});
</script>
{% endblock %}