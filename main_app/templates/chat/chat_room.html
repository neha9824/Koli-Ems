{% extends 'main_app/base.html' %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock page_title %}

{% block custom_css %}
<style>
    .chat-container {
        display: flex;
        height: calc(100vh - 150px);
        border: 1px solid #dee2e6;
        border-radius: 5px;
        overflow: hidden;
    }
    

    /* Attachment styles */
    .attachment-preview {
        max-width: 200px;
        border-radius: 5px;
        margin-top: 5px;
    }

    .attachment-preview img {
        max-width: 100%;
        border-radius: 5px;
    }

    /* Message status indicators */
    .message-status {
        font-size: 10px;
        margin-left: 5px;
    }

    /* Typing indicator animation */
    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        margin: 0 2px;
        animation: typing-bounce 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: 0s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing-bounce {
        0%, 60%, 100% { transform: translateY(0); }
        30% { transform: translateY(-5px); }
    }

    /* Responsive adjustments */
    @media (max-width: 576px) {
        .message {
            max-width: 90%;
        }
        
        .chat-sidebar {
            max-height: 250px;
        }
        
        .chat-header-name {
            font-size: 16px;
        }
    }
    .highlight-message {
        animation: highlight-fade 3s;
        background-color: rgba(78, 115, 223, 0.1);
        border-left: 3px solid #4e73df;
    }

    @keyframes highlight-fade {
        0% { background-color: rgba(78, 115, 223, 0.3); }
        100% { background-color: rgba(78, 115, 223, 0.1); }
    }
    .chat-sidebar {
        width: 300px;
        border-right: 1px solid #dee2e6;
        background-color: #f8f9fa;
        overflow-y: auto;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #fff;
    }
    
    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
    }
    
    .chat-header-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        object-fit: cover;
    }
    
    .chat-header-info {
        flex: 1;
    }
    
    .chat-header-name {
        font-weight: 600;
        margin: 0;
    }
    
    .chat-header-status {
        font-size: 12px;
        color: #6c757d;
        margin: 0;
    }
    
    .chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #f5f5f5;
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 70%;
    }
    
    .message-sent {
        margin-left: auto;
        text-align: right;
    }
    
    .message-received {
        margin-right: auto;
    }
    
    .message-content {
        display: inline-block;
        padding: 10px 15px;
        border-radius: 18px;
        position: relative;
        word-wrap: break-word;
    }
    
    .message-sent .message-content {
        background-color: #4e73df;
        color: white;
        border-top-right-radius: 0;
    }
    
    .message-received .message-content {
        background-color: #e9ecef;
        color: #343a40;
        border-top-left-radius: 0;
    }
    
    .message-time {
        font-size: 11px;
        color: #6c757d;
        margin-top: 5px;
    }
    
    .message-sent .message-time {
        text-align: right;
    }
    
    .chat-input {
        padding: 15px;
        border-top: 1px solid #dee2e6;
        display: flex;
        align-items: center;
    }
    
    .chat-input-text {
        flex: 1;
        padding: 10px 15px;
        border: 1px solid #ced4da;
        border-radius: 20px;
        outline: none;
        resize: none;
    }
    
    .chat-input-text:focus {
        border-color: #4e73df;
    }
    
    .chat-input-btn {
        margin-left: 10px;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .typing-indicator {
        font-size: 12px;
        color: #6c757d;
        padding: 0 15px 5px;
        font-style: italic;
    }
    
    .message-day-divider {
        text-align: center;
        margin: 15px 0;
        position: relative;
    }
    
    .message-day-divider::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background-color: #dee2e6;
        z-index: -1;
    }
    
    .message-day-divider span {
        background-color: #f5f5f5;
        padding: 0 10px;
        color: #6c757d;
        font-size: 12px;
    }
    
    @media (max-width: 768px) {
        .chat-container {
            flex-direction: column;
            height: auto;
        }
        
        .chat-sidebar {
            width: 100%;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            max-height: 300px;
        }
        
        .message {
            max-width: 85%;
        }
    }
</style>
{% endblock %}

{% extends 'main_app/base.html' %}
{% load static %}

{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'chat_home' %}" class="btn btn-default mr-3">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            {% with other_user=room.get_other_participant(request.user) %}
                                {% if other_user.profile_pic %}
                                    <img src="{{ other_user.profile_pic.url }}" class="rounded-circle mr-3" width="40" height="40">
                                {% else %}
                                    <img src="{% static 'dist/img/avatar.png' %}" class="rounded-circle mr-3" width="40" height="40">
                                {% endif %}
                                <h3 class="card-title mb-0">{{ other_user.get_full_name }}</h3>
                            {% endwith %}
                        </div>
                    </div>
                    
                    <div class="card-body chat-messages" style="height: 400px; overflow-y: auto;">
                        {% for message in messages %}
                        <div class="mb-3 {% if message.sender == request.user %}text-right{% endif %}">
                            <div class="d-flex {% if message.sender == request.user %}justify-content-end{% endif %}">
                                <div class="{% if message.sender == request.user %}bg-primary text-white{% else %}bg-light{% endif %} rounded p-3" style="max-width: 70%;">
                                    {{ message.message }}
                                    <div class="text-muted small mt-1">
                                        {{ message.timestamp|time }}
                                        {% if message.sender == request.user %}
                                            {% if message.read %}
                                            <i class="fas fa-check-double ml-1"></i>
                                            {% else %}
                                            <i class="fas fa-check ml-1"></i>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="card-footer">
                        <form method="post" action="{% url 'chat_room' room.id %}" class="d-flex">
                            {% csrf_token %}
                            <input type="text" name="message" class="form-control mr-2" placeholder="Type your message...">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block custom_js %}
<script>
$(document).ready(function() {
    const roomId = {{ room.id }};
    const userId = {{ request.user.id }};
    let lastMessageId = {% if page_obj %}{{ page_obj.last.id }}{% else %}0{% endif %};
    
    // WebSocket connection
    const chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomId + '/'
    );
    
    const chatMessages = $('#chatMessages');
    const messageInput = $('#messageInput');
    const sendMessageBtn = $('#sendMessageBtn');
    const typingIndicator = $('#typingIndicator');

    // Scroll to bottom of chat on load
    chatMessages.scrollTop(chatMessages[0].scrollHeight);
    
    // Send a message
    function sendMessage() {
        const messageText = messageInput.val().trim();
        if (messageText) {
            chatSocket.send(JSON.stringify({
                'message': messageText,
                'sender_id': userId
            }));
            messageInput.val('');
            messageInput.height('auto'); // Reset height
        }
    }

    // Typing indicator logic
    let typingTimer;
    const typingTimeout = 2000; // 2 seconds

    messageInput.on('input', function() {
        // Send typing notification
        chatSocket.send(JSON.stringify({
            'typing': true,
            'sender_id': userId
        }));
        
        // Clear previous timer
        clearTimeout(typingTimer);
        
        // Set timer to stop typing notification
        typingTimer = setTimeout(function() {
            chatSocket.send(JSON.stringify({
                'typing': false,
                'sender_id': userId
            }));
        }, typingTimeout);
    });

    // Send message on Enter (without Shift)
    messageInput.keypress(function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Send message on button click
    sendMessageBtn.click(sendMessage);

    // Handle incoming WebSocket messages
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);

        if (data.typing !== undefined) {
            // Typing indicator handling
            if (data.sender_id !== userId) {
                if (data.typing) {
                    typingIndicator.text(`${data.sender_name || "Someone"} is typing...`).show();
                } else {
                    typingIndicator.hide();
                }
            }
        } else {
            // Regular message handling
            if (data.sender_id != userId) {
                const messageHtml = `
                    <div class="message message-received">
                        <div class="message-content">
                            ${data.message}
                        </div>
                        <div class="message-time">
                            ${data.timestamp}
                        </div>
                    </div>
                `;
                chatMessages.append(messageHtml);
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
                lastMessageId = data.message_id;
            }
        }
    };
    // Message search
    $('#messageSearchInput').on('input', function() {
        const query = $(this).val();
        if (query.length > 2) {
            $.ajax({
                url: '{% url "search_messages" room.id %}',
                data: { q: query },
                success: function(data) {
                    $('#messageSearchResults').html(data);
                }
            });
        } else {
            $('#messageSearchResults').empty();
        }
    });

    // Highlight message when coming from search
    const urlParams = new URLSearchParams(window.location.search);
    const highlightMessageId = urlParams.get('highlight');
    if (highlightMessageId) {
        const messageElement = $(`[data-message-id="${highlightMessageId}"]`);
        if (messageElement.length) {
            messageElement.addClass('highlight-message');
            setTimeout(() => {
                messageElement.removeClass('highlight-message');
            }, 3000);
            $('html, body').animate({
                scrollTop: messageElement.offset().top - 100
            }, 500);
        }
    }
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    let fileToUpload = null;

    $('#attachFileBtn').click(function() {
        $('#fileInput').click();
    });

    $('#fileInput').change(function() {
        if (this.files && this.files[0]) {
            fileToUpload = this.files[0];
            $('#attachmentName').text(fileToUpload.name);
            $('#attachmentPreview').show();
        }
    });

    $('#removeAttachmentBtn').click(function() {
        fileToUpload = null;
        $('#fileInput').val('');
        $('#attachmentPreview').hide();
    });

    function sendMessage() {
        const messageText = $('#messageInput').val().trim();
        
        if (messageText || fileToUpload) {
            const formData = new FormData();
            formData.append('message', messageText);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            
            if (fileToUpload) {
                formData.append('attachment', fileToUpload);
            }
            
            $.ajax({
                url: '{% url "send_message" room.id %}',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if (data.status === 'success') {
                        appendMessage(data.message);
                        $('#messageInput').val('');
                        $('#fileInput').val('');
                        $('#attachmentPreview').hide();
                        fileToUpload = null;
                        lastMessageId = data.message.id;
                    }
                }
            });
        }
    }

    // Auto-resize textarea
    messageInput.on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});
</script>
{% endblock %}
